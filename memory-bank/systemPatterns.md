# System Patterns

## Architecture Overview

### Backend Architecture (Django)
- **MVT Pattern**: Models define data structure, Views handle API logic, Templates serve admin interface
- **App Structure**: Single `tours` app containing all VR-related functionality
- **RESTful API**: Django REST Framework providing JSON endpoints for frontend consumption
- **Media Handling**: Django file uploads with configurable storage backends

### Frontend Architecture (React + Three.js)
- **Component-Based**: Modular React components for different views and functionality
- **State Management**: React Context/useState for application state (no external state library needed)
- **3D Rendering**: Three.js with React Three Fiber for declarative 3D scene management
- **API Integration**: Axios for HTTP communication with Django backend

## Key Design Patterns

### 1. Data Models Hierarchy
```
Tour (1) → Scenes (many) → Hotspots (many)
```
- Tours contain multiple ordered scenes
- Scenes have 360° panoramas and optional audio
- Hotspots connect scenes within the same tour
- Foreign key relationships ensure data integrity

### 2. API Design Pattern
- **List Endpoints**: Lightweight data for browsing (tours list)
- **Detail Endpoints**: Full data with relationships (tour with scenes and hotspots)
- **Nested Resources**: `/api/tours/{id}/scenes/{id}/hotspots/`
- **Media URLs**: Absolute URLs generated by Django for frontend consumption

### 3. Component Architecture
```
App
├── TourList (browse tours)
├── TourViewer
│   ├── VRScene (Three.js 360° rendering)
│   ├── NavigationControls
│   ├── AudioControls
│   └── SceneInfo
```

### 4. 3D Scene Management
- **Spherical Coordinates**: Hotspots positioned using yaw/pitch angles
- **Camera Controls**: OrbitControls for smooth 360° navigation
- **Texture Loading**: Efficient panoramic image loading and caching
- **Audio Integration**: Synchronized audio playback with scene changes

## Database Design Patterns

### Model Relationships
- **Tour** → **Scene**: One-to-many with ordering
- **Scene** → **Hotspot**: One-to-many for navigation points
- **Hotspot**: References source and target scenes (same tour)

### Key Constraints
- Scene ordering within tours (unique_together)
- Hotspot validation (same tour, different scenes)
- File upload paths organized by content type
- Coordinate validation (yaw: -180°→180°, pitch: -90°→90°)

## Performance Patterns

### Backend Optimizations
- **Query Optimization**: `select_related()` and `prefetch_related()` for API endpoints
- **Media Serving**: Efficient file serving with proper headers
- **Pagination**: Large datasets handled with DRF pagination
- **Caching**: Ready for Redis integration for frequently accessed data

### Frontend Optimizations
- **Lazy Loading**: Components and assets loaded on-demand
- **Texture Caching**: Three.js texture management for smooth navigation
- **State Optimization**: Minimal re-renders through proper React patterns
- **Bundle Splitting**: Vite code splitting for optimal loading

## Security Patterns
- **CORS Configuration**: Restricted origins for API access
- **File Validation**: Image and audio file type validation
- **Input Sanitization**: Django form validation for all user inputs
- **Media Paths**: Organized upload paths prevent directory traversal 