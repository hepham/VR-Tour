# System Patterns

## Architecture Overview

### Backend Architecture (Django)
- **MVT Pattern**: Models define data structure, Views handle API logic, Templates serve admin interface
- **App Structure**: Single `tours` app containing all VR-related functionality
- **RESTful API**: Django REST Framework providing JSON endpoints for frontend consumption
- **Media Handling**: Django file uploads with configurable storage backends

### Frontend Architecture (React + Three.js)
- **Component-Based**: Modular React components for different views and functionality
- **State Management**: React Context/useState for application state (no external state library needed)
- **3D Rendering**: Three.js with React Three Fiber for declarative 3D scene management
- **API Integration**: Axios for HTTP communication with Django backend

## Key Design Patterns

### 1. Data Models Hierarchy
```
Tour (1) → Scenes (many) → Hotspots (many)
```
- Tours contain multiple ordered scenes
- Scenes have 360° panoramas and optional audio
- Hotspots connect scenes within the same tour
- Foreign key relationships ensure data integrity

### 2. API Design Pattern
- **List Endpoints**: Lightweight data for browsing (tours list)
- **Detail Endpoints**: Full data with relationships (tour with scenes and hotspots)
- **Nested Resources**: `/api/tours/{id}/scenes/{id}/hotspots/`
- **Media URLs**: Absolute URLs generated by Django for frontend consumption

### 3. Component Architecture
```
App
├── TourList (browse tours)
├── TourViewer (complete tour experience)
│   ├── VRScene (advanced Three.js 360° rendering)
│   │   ├── CameraController (smooth interpolation)
│   │   ├── PanoramaSphere (optimized texture loading)
│   │   ├── Hotspot (3D navigation points)
│   │   └── CheckpointMarker (educational content)
│   ├── AudioPlayer (advanced audio controls)
│   ├── Controls (navigation interface)
│   └── SceneViewer (scene management)
├── VRDemo (standalone demo mode)
├── TourEditor (NEW - content creation interface)
│   ├── EditorLayout (sidebar + main + viewer)
│   ├── SceneEditor (scene management panel)
│   │   ├── SceneList (sidebar with drag-drop ordering)
│   │   ├── SceneForm (metadata input forms)
│   │   └── FileUploader (360° image upload)
│   ├── HotspotEditor (visual hotspot placement)
│   │   ├── HotspotPlacer (click-to-place on 360° view)
│   │   ├── HotspotList (connection management)
│   │   └── HotspotForm (hotspot configuration)
│   ├── TourMetadataForm (tour info and settings)
│   └── EditorPreview (real-time VRScene preview)
└── Additional Components
    ├── CheckpointModal (detailed content display)
    ├── CheckpointList (content management)
    └── SceneViewer (scene transition handling)
```

### 4. Advanced 3D Scene Management
- **Spherical Coordinates**: Hotspots and checkpoints positioned using yaw/pitch angles
- **Advanced Camera Controls**: Custom CameraController with smooth interpolation
- **Performance Optimization**: User interaction awareness and throttled updates
- **Adaptive Behavior**: Zoom-dependent rotation speed and damping adjustments
- **Texture Loading**: Efficient panoramic image loading with error handling
- **Audio Integration**: Synchronized audio playback with advanced controls
- **Memory Management**: Optimized Three.js resource cleanup and texture caching

### 5. Performance Optimization Patterns
- **Throttled Updates**: Aggressive throttling during user interaction (10fps vs 60fps)
- **Smooth Interpolation**: Lerp-based camera transitions with configurable damping
- **Lazy Loading**: Components and textures loaded on-demand
- **User Interaction Detection**: Different behavior modes for active vs idle states
- **Resource Cleanup**: Proper disposal of Three.js resources to prevent memory leaks

### 6. Content Creation Patterns (TourEditor)
- **File Upload Strategy**: Chunked upload for large panoramic images with progress tracking
- **Visual Editing**: Click-to-place hotspots directly on 360° preview
- **Real-time Preview**: Integrated VRScene for immediate feedback during editing
- **Auto-save Pattern**: Periodic state persistence to prevent data loss
- **Drag-and-Drop**: Scene reordering and file upload with visual feedback
- **Form Validation**: Real-time validation with immediate user feedback
- **State Management**: Centralized editor state with undo/redo capabilities

## Database Design Patterns

### Model Relationships
- **Tour** → **Scene**: One-to-many with ordering
- **Scene** → **Hotspot**: One-to-many for navigation points
- **Hotspot**: References source and target scenes (same tour)

### Key Constraints
- Scene ordering within tours (unique_together)
- Hotspot validation (same tour, different scenes)
- File upload paths organized by content type
- Coordinate validation (yaw: -180°→180°, pitch: -90°→90°)

## Performance Patterns

### Backend Optimizations
- **Query Optimization**: `select_related()` and `prefetch_related()` for API endpoints
- **Media Serving**: Efficient file serving with proper headers
- **Pagination**: Large datasets handled with DRF pagination
- **Caching**: Ready for Redis integration for frequently accessed data

### Frontend Optimizations
- **Lazy Loading**: Components and assets loaded on-demand
- **Texture Caching**: Three.js texture management for smooth navigation
- **State Optimization**: Minimal re-renders through proper React patterns
- **Bundle Splitting**: Vite code splitting for optimal loading

## Security Patterns
- **CORS Configuration**: Restricted origins for API access
- **File Validation**: Image and audio file type validation
- **Input Sanitization**: Django form validation for all user inputs
- **Media Paths**: Organized upload paths prevent directory traversal 